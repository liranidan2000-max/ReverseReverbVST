name: Build VST3 & Installers

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ==========================================
  # Windows Build + NSIS Installer
  # ==========================================
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --target ReverseReverb_VST3 ReverseReverb_Standalone

      - name: Find built artifacts
        shell: pwsh
        run: |
          Write-Host "=== Looking for VST3 ==="
          Get-ChildItem -Recurse -Filter "*.vst3" build/ | ForEach-Object { Write-Host $_.FullName }
          Write-Host "=== Looking for EXE ==="
          Get-ChildItem -Recurse -Filter "ReverseReverb.exe" build/ | ForEach-Object { Write-Host $_.FullName }

      - name: Prepare installer files
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path installer/vst3
          New-Item -ItemType Directory -Force -Path installer/standalone

          # Copy VST3 bundle
          $vst3 = Get-ChildItem -Recurse -Filter "ReverseReverb.vst3" build/ -Directory | Select-Object -First 1
          if ($vst3) {
            Copy-Item -Recurse $vst3.FullName installer/vst3/
            Write-Host "VST3 copied: $($vst3.FullName)"
          }

          # Copy standalone exe
          $exe = Get-ChildItem -Recurse -Filter "ReverseReverb.exe" build/ | Select-Object -First 1
          if ($exe) {
            Copy-Item $exe.FullName installer/standalone/
            Write-Host "Standalone copied: $($exe.FullName)"
          }

      - name: Create NSIS installer script
        shell: pwsh
        run: |
          @"
          !include "MUI2.nsh"

          Name "ReverseReverb"
          OutFile "ReverseReverb-Setup.exe"
          InstallDir "`$PROGRAMFILES\ReverseReverb"
          RequestExecutionLevel admin

          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH
          !insertmacro MUI_LANGUAGE "English"

          Section "VST3 Plugin" SecVST3
            SetOutPath "`$COMMONFILES\VST3"
            File /r "installer\vst3\ReverseReverb.vst3"
          SectionEnd

          Section "Standalone Application" SecStandalone
            SetOutPath "`$INSTDIR"
            File "installer\standalone\ReverseReverb.exe"
            CreateShortcut "`$DESKTOP\ReverseReverb.lnk" "`$INSTDIR\ReverseReverb.exe"
            CreateDirectory "`$SMPROGRAMS\ReverseReverb"
            CreateShortcut "`$SMPROGRAMS\ReverseReverb\ReverseReverb.lnk" "`$INSTDIR\ReverseReverb.exe"
            CreateShortcut "`$SMPROGRAMS\ReverseReverb\Uninstall.lnk" "`$INSTDIR\Uninstall.exe"
            WriteUninstaller "`$INSTDIR\Uninstall.exe"
          SectionEnd

          Section "Uninstall"
            RMDir /r "`$COMMONFILES\VST3\ReverseReverb.vst3"
            RMDir /r "`$INSTDIR"
            Delete "`$DESKTOP\ReverseReverb.lnk"
            RMDir /r "`$SMPROGRAMS\ReverseReverb"
          SectionEnd
          "@ | Out-File -Encoding ASCII installer.nsi

      - name: Build installer with NSIS
        shell: pwsh
        run: |
          choco install nsis -y --no-progress
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

      - name: Upload VST3 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReverseReverb-Windows-VST3
          path: installer/vst3/

      - name: Upload Standalone artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReverseReverb-Windows-Standalone
          path: installer/standalone/

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: ReverseReverb-Windows-Installer
          path: ReverseReverb-Setup.exe

  # ==========================================
  # macOS Build + DMG Installer
  # ==========================================
  build-macos:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode 15
        run: |
          ls /Applications/ | grep Xcode
          sudo xcode-select -s /Applications/Xcode_15.4.app || sudo xcode-select -s /Applications/Xcode_15.2.app || sudo xcode-select -s $(ls -d /Applications/Xcode_15*.app | head -1)
          xcodebuild -version

      - name: Configure CMake
        run: >
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_OSX_ARCHITECTURES="arm64"
          -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0

      - name: Build
        run: cmake --build build --config Release --target ReverseReverb_VST3 ReverseReverb_Standalone

      - name: Find built artifacts
        run: |
          echo "=== Looking for VST3 ==="
          find build -name "*.vst3" -type d
          echo "=== Looking for .app ==="
          find build -name "*.app" -type d

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Prepare DMG content
        run: |
          mkdir -p dmg-content

          # Copy VST3 bundle
          VST3_PATH=$(find build -name "ReverseReverb.vst3" -type d | head -1)
          if [ -n "$VST3_PATH" ]; then
            cp -R "$VST3_PATH" dmg-content/
            echo "VST3 copied: $VST3_PATH"
          fi

          # Copy Standalone .app bundle
          APP_PATH=$(find build -name "ReverseReverb.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            cp -R "$APP_PATH" dmg-content/
            echo "App copied: $APP_PATH"
          fi

      - name: Create DMG background
        run: |
          # Create background using macOS built-in tools (no Pillow needed)
          python3 -c "
          import struct, zlib

          w, h = 660, 400
          # Build raw RGB pixels
          raw = bytearray()
          for y in range(h):
              raw.append(0)  # PNG filter: None
              t = y / h
              for x in range(w):
                  r = int(15 + t * 30)
                  g = int(5 + t * 15)
                  b = int(35 + (1 - t) * 45)
                  raw.extend([r, g, b])

          # Write minimal PNG
          def chunk(ctype, data):
              c = ctype + data
              return struct.pack('>I', len(data)) + c + struct.pack('>I', zlib.crc32(c) & 0xffffffff)

          with open('dmg-background.png', 'wb') as f:
              f.write(b'\x89PNG\r\n\x1a\n')
              f.write(chunk(b'IHDR', struct.pack('>IIBBBBB', w, h, 8, 2, 0, 0, 0)))
              f.write(chunk(b'IDAT', zlib.compress(bytes(raw), 9)))
              f.write(chunk(b'IEND', b''))
          print('DMG background created: %dx%d' % (w, h))
          "

      - name: Create professional DMG
        run: |
          # Create DMG with drag-to-install layout
          # First create a temporary DMG with the content
          mkdir -p dmg-stage

          # Copy built items
          cp -R dmg-content/ReverseReverb.vst3 dmg-stage/ 2>/dev/null || true
          cp -R dmg-content/ReverseReverb.app dmg-stage/ 2>/dev/null || true

          # Create symlinks for drag-to-install
          ln -s "/Library/Audio/Plug-Ins/VST3" dmg-stage/"VST3 Folder"
          ln -s /Applications dmg-stage/Applications

          # Create the DMG with create-dmg (professional layout)
          create-dmg \
            --volname "ReverseReverb Installer" \
            --background "dmg-background.png" \
            --window-pos 200 120 \
            --window-size 660 400 \
            --icon-size 80 \
            --icon "ReverseReverb.vst3" 130 200 \
            --icon "ReverseReverb.app" 330 200 \
            --icon "VST3 Folder" 130 320 \
            --icon "Applications" 530 200 \
            --hide-extension "ReverseReverb.app" \
            --no-internet-enable \
            "ReverseReverb-macOS.dmg" \
            "dmg-stage/" || true

          # Fallback: if create-dmg failed, create simple DMG
          if [ ! -f "ReverseReverb-macOS.dmg" ]; then
            echo "create-dmg failed, creating simple DMG..."
            hdiutil create -volname "ReverseReverb" \
              -srcfolder dmg-stage \
              -ov -format UDZO \
              ReverseReverb-macOS.dmg
          fi

          ls -la ReverseReverb-macOS.dmg

      - name: Upload macOS VST3
        uses: actions/upload-artifact@v4
        with:
          name: ReverseReverb-macOS-VST3
          path: dmg-content/ReverseReverb.vst3

      - name: Upload macOS Standalone
        uses: actions/upload-artifact@v4
        with:
          name: ReverseReverb-macOS-Standalone
          path: dmg-content/ReverseReverb.app

      - name: Upload macOS DMG Installer
        uses: actions/upload-artifact@v4
        with:
          name: ReverseReverb-macOS-DMG
          path: ReverseReverb-macOS.dmg
